<html>
	<head>
		<script src="jquery-3.3.1.min.js"></script>
		<script src="https://kit.fontawesome.com/a26119ff4e.js" crossorigin="anonymous"></script>
		<style>
			.card_selected {
				background-color: powderblue;
			}
			.current_player {
				background-color:blue;
				color:white;
			}
			.ready_player {
				background-color:#33cc33;
				color:white;				
			}
			.card_name {
				position: absolute;
				top: 10%;
				left: 3%;
				font-size: 40px;
				color: white;
				vertical-align: middle;
			}
			.game_view {
				position: relative;
				width: 700px;
				height: 200px;
				background-color: #037ffc;
				text-align: center;
				vertical-align: middle;
			}
			.timer {
				font-size: 25px;
				color: yellow;
			}
			.next_card_btn {
				position: relative;
				top: -200px;
				left: 700px;
				width: 200px;
				height: 200px;
			}
			.clickable_card {
				display: block;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
				-khtml-user-select: none;
				-moz-user-select: none;
				-ms-user-select: none;
				user-select: none;
			}
			.viewedcards_block {
				width: 330px;
				height: 200px;
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<div id="joinroom_div" name="joinroom_div">
			<label for="nickname_text">Nickname:</label>
			<input type="text" id="nickname_text" name="nickname_text"></input> 
			
			<br>
			
			<button type="button" id="joinroom_button" name="joinroom_button">Join Room</button>
		</div>
		<div id="submitdeck_div" name="submitdeck_div" style="display: none; visibility: hidden;">
			<!-- <label for="decklist_textarea">Deck</label> -->
			Deck

			<br>

			<label for="new_card_text">Card Title:</label>
			<input type="text" id="new_card_text" name="new_card_text">
			<button type="button" id="addcard_button" name="addcard_button"><i class="fas fa-plus-circle"></i></button>
			<button type="button" id="removecard_button" name="removecard_button"><i class="fas fa-minus-square"></i></button>

			<br>

			<div id="decklist_textarea" name="decklist_textarea" style="border:1px solid black;">
				<span id="decklist_textarea_line1" name="decklist_textarea_line1" class="decklist_textarea_line" style="display: block;"></span>
				<span id="decklist_textarea_line2" name="decklist_textarea_line2" class="decklist_textarea_line" style="display: block;"></span>
				<span id="decklist_textarea_line3" name="decklist_textarea_line3" class="decklist_textarea_line" style="display: block;"></span>
				<span id="decklist_textarea_line4" name="decklist_textarea_line4" class="decklist_textarea_line" style="display: block;"></span>
				<span id="decklist_textarea_line5" name="decklist_textarea_line5" class="decklist_textarea_line" style="display: block;"></span>
				<span id="decklist_textarea_line6" name="decklist_textarea_line6" class="decklist_textarea_line" style="display: block;"></span>
				<span id="decklist_textarea_line7" name="decklist_textarea_line7" class="decklist_textarea_line" style="display: block;"></span>
			</div>

			<br>

			<button type="button" id="submitdeck_button" name="submitdeck_button">Submit Deck</button>	
		</div>
		<div id="listplayers_div" name="listplayers_div" style="display: none; visibility: hidden;">
			<table id="playerlist_table" name="playerlist_table">
				<tr>
					<th><b>Player</b></th>
					<th><b>Ready</b></th>
				</tr>
			</table>
		</div>
		<div id="gamestate_div" name="gamestate_div" style="display: none; visibility: hidden;">
			<table id="correctguesses_table" name="correctguesses_table" style="width: 700px; display: none">
				<tr>
					<td><label>Viewed Cards</label></td>
					<td><label>Correct Guesses</label></td>
				</tr>
				<tr>
					<td>
						<div id="viewedcards_textarea" name="viewedcards_textarea" class="viewedcards_block">
						</div>
					</td>
					<td>
						<div id="acquiredcards_textarea" name="acquiredcards_textarea" class="viewedcards_block">
						</div>
					</td>
				</tr>
				<tr>
					<td><button type="button" id="submitAcquiredCards_button" name="submitAcquiredCards_button">Submit</button></td>
				</tr>
			</table>

			<div id="gameview_div" name="gameview_div" class="game_view" style="display: none;">
				<span id="cardname_span" name="cardname_span" class="card_name">Card name will show up here</span>
				<span id="timer_span" name="timer_span" class="timer">00:00</span>
			</div>
			<button type="button" id="nextcard_button" name="nextcard_button" class="next_card_btn" style="display: none;">Double click for next card</button>
			<table id="teamscore_table" name="teamscore_table">
				<tr>
					<th><b>Score T1</b></th>
					<th><b>Score T2</b></th>
				</tr>
			</table>
			<table id="team_table" name="team_table">
				<tr>
					<th><b>Team 1</b></th>
					<th><b>Team 2</b></th>
				</tr>
			</table>
			<button type="button" id="readytoplay_button" name="readytoplay_button" style="display: none;">Ready</button>
			<button type="button" id="startturn_button" name="startturn_button" style="display: none;" disabled>Start Turn</button>
			<table id="teamcards_table" name="teamcards_table">
				<tr>
					<th><b>Team 1 Cards</b></th>
					<th><b>Team 2 Cards</b></th>
				</tr>
			</table>
		</div>	
	</body>
</html>

<script>
var loading = false;
var my_nick = "";
var list_of_cards = [];
var deck = [];
var viewed_cards = [];
var timer_value = 0;
var MAX_CARDS_PER_PLAYER = 7;
var const_call_function = null;
var timer_call_function = null;
var last_stage = "";

function makeRequest(url, type, input_data, callback_function) {
	var api_base_url = 'http://timesup-titlerecall.herokuapp.com/'

	if (type == 'POST') {
		$.post(api_base_url + url, input_data, function(data){
			//console.log('POST');
			//console.log(data)

			callback_function(JSON.parse(data));
		});
	}
	else {
		$.get(api_base_url + url, function (data) {
			//console.log('GET');
			//console.log(data);

			callback_function(JSON.parse(data));
		});
	}
}

$('#joinroom_button').click(function() {
	var nickname_text = $('#nickname_text').val();
	//console.log('nickname_text: ' + nickname_text);

	if (nickname_text === "") {
		alert('You must select a nickname.');
	}
	else {
		$('#joinroom_button').attr('disabled', true);
		$('#nickname_text').attr('disabled', true);
		my_nick = nickname_text;
		joinRoom(nickname_text);
	}
});

function joinRoom(nickname) {
	makeRequest("joinroom", "POST", '{"nickname": "' + nickname + '", "code": "XX"}', callback_joinRoom);
}

function callback_joinRoom(data) {
	var status = data['status'];
	var message = data['message'];

	if (status === "failed") {
		$('#joinroom_button').attr('disabled', false);
		$('#nickname_text').attr('disabled', false);
		my_nick = "";

		alert(message);
	}
	else {
		$('#joinroom_div').attr('disabled', true);
		$('#joinroom_div').attr('display', 'none');
		$('#joinroom_div').hide();

		alert(message);

		$('#submitdeck_div').attr('style', 'display: block; visibility: visible;');
	}
}

$('#new_card_text').keypress(function(e){
	if (e.which == 13) {
		$('#addcard_button').trigger("click");
	}
});

$('#addcard_button').click(function() {
	var card_title = $('#new_card_text').val();

	if (card_title === "") {
		alert("You need a card title to add.");
	}
	else {
		if (list_of_cards.length < MAX_CARDS_PER_PLAYER) {
			list_of_cards.push(card_title);
			updateDeckTextArea(false);
			$('#new_card_text').val("");
		}
	}
});

$('#removecard_button').click(function() {
	var cards_to_remove = [];

	$(".card_selected").each(function() {
		cards_to_remove.push($(this).text());
	});

	for (var i=0; i<cards_to_remove.length; i++) {
		for (var j=0; j<list_of_cards.length; j++) {
			if (cards_to_remove[i] === list_of_cards[j]){
				list_of_cards.splice(j, 1);
				break;
			}
		}
	}

	updateDeckTextArea(true);
});

$('#submitdeck_button').click(function(){
	if (list_of_cards.length < MAX_CARDS_PER_PLAYER) {
		alert("You need to choose " + MAX_CARDS_PER_PLAYER + " cards.");
	}
	else {
		$('#new_card_text').attr("disabled", true);
		$('#addcard_button').attr("disabled", true);
		$('#removecard_button').attr("disabled", true);
		$('#decklist_textarea').attr("disabled", true);
		$('#submitdeck_button').attr("disabled", true);

		submitDeck(list_of_cards);
	}
});

function submitDeck(cardlist) {
	var deck = [];

	for (var i=0; i<cardlist.length; i++) {
		deck.push({"title": cardlist[i]});
	}

	makeRequest('submitdeck', "POST", '{"nickname": "' + my_nick + '", "deck": ' + JSON.stringify(deck) + '}', callback_submitDeck);
}

function callback_submitDeck(data) {
	var status = data['status'];
	var message = data['message'];

	if (status === "failed") {
		alert(message);
	}
	else {
		$('#submitdeck_div').attr('disabled', true);
		$('#submitdeck_div').attr('display', 'none');
		$('#submitdeck_div').hide();

		alert(message);

		$('#listplayers_div').attr('style', 'display: block; visibility: visible;');
		populateListOfPlayersDiv();
		const_call_function = window.setInterval(populateListOfPlayersDiv, 5000);
	}
}

$('.decklist_textarea_line').click(function() {
	$(this).toggleClass("card_selected");
})

function updateDeckTextArea(unselect) {
	for (var i=1; i<=list_of_cards.length; i++) {
		$('#decklist_textarea_line' + i).text(list_of_cards[i-1]);
		if (unselect) {
			$('#decklist_textarea_line' + i).toggleClass('card_selected', false);
		}
	}
	for (var j=list_of_cards.length+1; j<=MAX_CARDS_PER_PLAYER; j++) {
		$('#decklist_textarea_line' + j).text("");
		$('#decklist_textarea_line' + j).toggleClass('card_selected', false);
	}
}

function populateListOfPlayersDiv() {
	makeRequest('listplayers', "GET", '{}', callback_populateListOfPlayersDiv);
}

function callback_populateListOfPlayersDiv(data) {
	$('#playerlist_table').empty();
	$('#playerlist_table').append("<tr><th><b>Player</b></th><th><b>Ready</b></th></tr>");

	for (player_index in data) {
		if (data[player_index]["player"] !== "game is currently starting") {
			$('#playerlist_table').append("<tr><td>" + data[player_index]["player"] + "</td><td>" + data[player_index]["ready"] + "</td></tr>")
		}
		else {
			clearInterval(const_call_function);

			$('#listplayers_div').attr('disabled', true);
			$('#listplayers_div').attr('display', 'none');
			$('#listplayers_div').hide();

			$('#gamestate_div').attr('style', 'display: block; visibility: visible;');

			window.setInterval(populateGameStateDiv, 1000);
			/*var seconds_now = (new Date()).getSeconds() % 10;
			var delay_time = 
			if (seconds_now > 5) {

			}*/
			//populateListOfPlayersDiv();
			//window.setInterval(populateListOfPlayersDiv, 5000);
		}
	}
}

$('#readytoplay_button').click(function() {
	readyToPlay(my_nick);
	$('#readytoplay_button').attr('disabled', true);
});

function readyToPlay(nickname) {
	makeRequest('gamestate', "POST", '{"status": "ready", "nickname": "' + nickname + '"}', callback_readyToPlay);
}

function callback_readyToPlay(data) {
}

$('#startturn_button').click(function() {
	$('#startturn_button').attr('disabled', true);
	$('#startturn_button').attr('style', 'display: none;');
	startTurn();
});

function startTurn() {
	makeRequest('startturn', "GET", '{}', callback_startTurn);
}

function callback_startTurn(data) {
	deck = data['deck'];
	viewed_cards = [deck[0]];

	$('#gameview_div').attr("style", "display: block");
	$('#cardname_span').attr("style", "display: block");
	$('#cardname_span').text(deck[0]['title']);
	$('#timer_span').attr("style", "display: block");
	$('#nextcard_button').attr("style", "display: block");

	timer_value = 36;
	timer_call_function = window.setInterval(timerRun, 1000);
}

$('#nextcard_button').dblclick(function() {
	var index = viewed_cards.length;
	
	if (index < deck.length) {
		viewed_cards.push(deck[index]);
	
		$('#cardname_span').text(deck[index]['title']);
	}
	else {
		$('#cardname_span').text("--- Deck Empty ---");	
	}
});

function timerRun() {
	timer_value = timer_value - 1;

	if (timer_value < 10) {
		$('#timer_span').text("00:0" + timer_value.toString());
	}
	else {
		$('#timer_span').text("00:" + timer_value.toString());
	}

	if (timer_value == 0) {
		clearInterval(timer_call_function);

		$('#gameview_div').attr("style", "display: none");
		$('#cardname_span').attr("style", "display: none");
		$('#timer_span').attr("style", "display: none");
		$('#nextcard_button').attr("style", "display: none");

		acquiredCards();
	}
}

function acquiredCards() {
	//$('#viewedcards_textarea').attr("style", "display:block");
	//$('#acquiredcards_textarea').attr("style", "display:block");
	//$('#correctguesses_table').empty();
	$('#viewedcards_textarea').empty();
	$('#acquiredcards_textarea').empty();
	$('#correctguesses_table').attr("style", "display:block; width: 700px;");

	for (card in viewed_cards) {
		var title = viewed_cards[card]["title"];

		$('#viewedcards_textarea').append('<span id="card_' + title + '" name="card_' + title + '" class="clickable_card">' + title + '</span>');
	}
}

function cardDoubleClick(element) {
	var current_div_id = element.parent().attr('id');
	var new_div_id = '';
	var title = element.text();
	var title_parsed = (element.text()).replace(/ /g, "_");

    $("#" + current_div_id).find(element).remove();

    if (current_div_id.includes("viewedcards")) {
    	new_div_id = 'acquiredcards_textarea';
    }
    else {
    	new_div_id = 'viewedcards_textarea';    	
    }

    $('#' + new_div_id).append('<span id="card_' + title_parsed + '" name="card_' + title_parsed + '" class="clickable_card">' + title + '</span>');
}

$('#acquiredcards_textarea').on('dblclick', 'span.clickable_card', function() {
	cardDoubleClick($(this));
});

$('#viewedcards_textarea').on('dblclick', 'span.clickable_card', function() {
	cardDoubleClick($(this));
});

$('#submitAcquiredCards_button').click(function() {
	var list_of_spans = $('#acquiredcards_textarea').find('span');
    var list_of_titles = [];

    $.each(list_of_spans, function(key, value) {
    	list_of_titles.push($(value).text());
    });

    var correct_cards = []
    for (card_index in deck) {
    	var card = deck[card_index];
    	if (list_of_titles.includes(card['title'])) {
    		correct_cards.push(card);
    	}
    	if (list_of_titles.length == correct_cards.length) {
    		break;
    	}
    }

    endTurn(correct_cards)
});

function endTurn(correct_cards) {
	$('#correctguesses_table').attr("style", "display:none; width: 700px;");
	makeRequest('endturn', 'POST', '{"correct": ' + JSON.stringify(correct_cards) + '}', callback_endTurn);
	deck = {};
}

function callback_endTurn(data) {
}

function populateGameStateDiv() {
	makeRequest('gamestate', "GET", '{}', callback_populateGameStateDiv);
}

function callback_populateGameStateDiv(data) {
	var teams = data["teams"];
	var total_number_of_players = 0;
	var current_player = [data["current_team"], data["current_player"]];
	var current_player_name = teams[current_player[0].toString()]['members'][current_player[1]]
	var ready_player_list = data["ready_player_list"];
	var current_stage = data["current_stage"];
	/*{"teams": teams,
	"current_team": current_team,
	"current_player": current_player,
	"ready_player_list": ready_player_list,
	"current_stage": current_stage}*/

	var number_of_members = 0;
	var number_of_cards = 0

	$('#team_table').empty();
	$('#team_table').append("<tr><th><b>Team 1</b></th><th><b>Team 2</b></th></tr>");

	$('#teamcards_table').empty();
	$('#teamcards_table').append("<tr><th><b>Team 1 Cards</b></th><th><b>Team 2 Cards</b></th></tr>");

	if (current_stage == "round ended") {
		if (last_stage != current_stage) {
			$('#teamscore_table').append("<tr>")

			for (team_index in teams) {
				$('#teamscore_table').append("<td>" + teams[team_index]["score"].toString() + "</td>");
			}

			$('#teamscore_table').append("</tr>")
		}
	}

	for (team_index in teams) {
		total_number_of_players = total_number_of_players + teams[team_index]['members'].length;

		if (teams[team_index]['members'].length > number_of_members) {
			number_of_members = teams[team_index]['members'].length;
		}

		if (teams[team_index]['acquired_cards'].length > number_of_cards) {
			number_of_cards = teams[team_index]['acquired_cards'].length;
		}
	}

	if (my_nick	=== current_player_name) {
		$('#startturn_button').attr('style', 'display: block');
		$('#readytoplay_button').attr('style', 'display: none');
		if (ready_player_list.length == total_number_of_players - 1 && current_stage === "round started") {
			$('#startturn_button').attr('disabled', false);
		}
	}
	else {
		$('#startturn_button').attr('style', 'display: none');
		$('#readytoplay_button').attr('style', 'display: block');
		if (!ready_player_list.includes(my_nick) && current_stage === "round started") {
			$('#readytoplay_button').attr('disabled', false);
		}
	}

	for (var i=0; i<number_of_members; i++) {
		$('#team_table').append("<tr>");
		for (var j=0; j<Object.keys(teams).length; j++) {
			if (teams[j.toString()]['members'].length >= i) {
				if (i == current_player[1] && j == current_player[0]) {
					$('#team_table').append("<td id=\"player_" + i + "" + j + "\" class=\"current_player\">" + teams[j.toString()]['members'][i] + "</td>");
				}
				else {
					$('#team_table').append("<td id=\"player_" + i + "" + j + "\">" + teams[j.toString()]['members'][i] + "</td>");
				}

				if (ready_player_list.includes(teams[j.toString()]['members'][i])) {
					$('#player_' + i + '' + j).toggleClass("ready_player");
				}
			}
			else {
				$('#team_table').append("<td></td>");
			}
		}
		$('#team_table').append("</tr>");
	}

	for (var i=0; i<number_of_cards; i++) {
		$('#teamcards_table').append("<tr>");
		for (var j=0; j<Object.keys(teams).length; j++) {
			if (teams[j.toString()]['acquired_cards'].length > i) {
				$('#teamcards_table').append("<td id=\"card_" + i + "" + j + "\">" + teams[j.toString()]['acquired_cards'][i]['title'] + "</td>");
			}
			else {
				$('#teamcards_table').append("<td></td>");
			}
		}
		$('#teamcards_table').append("</tr>");
	}

	last_stage = current_stage;
}

$(function () {
/*	makeRequest("generateroom", "GET", {});
	makeRequest("joinroom", "POST", '{"nickname": "christopher", "code": "XX"}');
	makeRequest("joinroom", "POST", '{"nickname": "ahmed", "code": "XX"}');
	makeRequest("joinroom", "POST", '{"nickname": "erica", "code": "XX"}');
	makeRequest("joinroom", "POST", '{"nickname": "fernando", "code": "XX"}');
	makeRequest('submitdeck', "POST", '{"nickname": "ahmed", "deck": [{"title": "Jurassic Park"}]}');
	makeRequest('submitdeck', "POST", '{"nickname": "christopher", "deck": [{"title": "Jurassic Park"}]}');
	makeRequest('submitdeck', "POST", '{"nickname": "erica", "deck": [{"title": "Jurassic Park"}]}');
	makeRequest('submitdeck', "POST", '{"nickname": "fernando", "deck": [{"title": "Jurassic Park"}]}');
	makeRequest('startgame', "GET", {});
	makeRequest('startround', "GET", {});
*/
});
</script>